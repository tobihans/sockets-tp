#!/usr/bin/env python3
#essai de programmes de messagerie
import socket
import logging

logging.basicConfig(filename="client.log", filemode="w", 
        format="[%(asctime)s]%(name)s::%(levelname)s => %(message)s",
        level=logging.INFO
    )
logging.info("socket instance created\n")
connect = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
host = input('ip-serveur: ')
s_port: int = 0;
try:
    s_port = int(input('port-serveur: '))
except:
    logging.warning("Invalid port value, defaulted to 3000.")
    s_port = 3000
connect = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
logging.info("Attempting to connect to server %s:%d\n", host, s_port)
connect.connect((host, s_port))
logging.info("Connection succeeded\n")
pseudo = input('Pseudo:')
received = b""
sent = b""
connect.send(b"Pseudo-interlocuteur:" + pseudo.encode())
logging.info("Discussion started\n")
try:
    while (not received.decode().endswith("end")) and sent != "end":
        received = connect.recv(1024)
        if received != b"":
            print(received.decode())
            sent = input('Moi: ')
            connect.send(pseudo.encode() +b": " + sent.encode())
except BrokenPipeError:
    print("Connection ferm√©e par le correspondant")
except:
    print("Une erreur est survenue!")
finally:
    connect.close()
    logging.info("COnnection closed[<<EOF>>]\n")
    print('<<EOF>>')
