#!/usr/bin/env python3
#essai de programmes de messagerie
import socket
import logging

# Configuration du logger pour une gestion des logs
logging.basicConfig(filename="server.log", filemode="w", 
        format="[%(asctime)s]%(name)s::%(levelname)s => %(message)s",
        level=logging.INFO
    )

connect = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
logging.info("socket instance created for client")
server = ''
try:
    port = int(input('port-serveur: '))
except:
    logging.warning("incorrect value for server port: 3800 chosen by default")
    port = 3800
connection = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connection.bind((server, port))
logging.info("waiting for connection.....")
connection.listen(5)
connect, info = connection.accept()
logging.info("connection established with %s", str(connect))
pseudo = input('pseudo:')
received = b""
sent = b""
logging.info("discussion started.")
connect.send(b"pseudo-interlocuteur:" + pseudo.encode())
try:
    while (not received.decode().endswith("end")) and sent != "end":
        received = connect.recv(1024)
        if received != b"":
            print(received.decode())
            sent = input('moi: ')
            connect.send(pseudo.encode() +b": " + sent.encode())
except BrokenPipeError:
    print("COnnection fermee par correspondant")
except:
    print("Une erreur est survenue")
finally:
    connect.close()
    logging.info("Connection closed[<<EOF>>]")
    print('<<EOF>>')
